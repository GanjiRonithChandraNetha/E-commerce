create table profile( 
profile_id bigint generated always as identity primary key,
mobile_number varchar(15) not null,
name varchar(50) not null,
profile_pic text
);

create table cart(
profile_id bigint,
cart_id bigint generated always as identity primary key,
status varchar(20) not null
check (status in ('active','ordered','abandoned'))
default 'active',
created_at timestamp not null default now(),
update_at timestamp not null default now(),

constraint fk_cart
foreign key(profile_id)
references profiles(profile_id)
on delete restrict
);

create table cart_items(
cart_items_id bigint primary key,
cart_id bigint not null,
variant_id bigint not null,
price_at_add_time int ,
added_at timestamp not null default now(),

constraint fk_cart_items
foreign key(cart_id) references cart(cart_id)
on delete casecade,
foreign key (variant_id) references variant
on delete restrict
);

create table products(
product_id bigint generated always as identity primary key,
price numeric(10,2) not null check ( price > 0.0),
product_description text not null,
product_name varchar(50) not null
);

create table images(
image_id bigint generated always as identity primary key,
variant_id bigint not null,
url text not null,

constraint fk_images_variants
foreign key (variant_id) references product_variants(variant_id)
on delete cascade
);

create table product_variants(
variant_id bigint generated always as identity primary key,
product_id bigint not null,
variant_name varchar(50) not null,
stock int not null check(stock >= 0),
price numeric(10,2) not null check(price > 0.0),
status varchar(10) not null 
check(status in ('in_stock','out_of_stock'))
default 'in_stock',

constraint fk_variants_products
foreign key (product_id) references products(product_id)
on delete cascade

)


create table orders(
order_id bigint generated always as identity primary key,
cart_id bigint not null,
profile_id bigint not null,
payment_status varchar(20) not null
check( payment_status in ('pending','paid','failed') )default 'pending',
delivery_status varchar(20) not null 
check(delivery_status in ('placed','shipped','delivered','canceled')) default 'placed',
created_at TIMESTAMP NOT NULL DEFAULT now(),
completed_at TIMESTAMP,


constraint fk_orders_cart_id
foreign key(cart_id) references carts(cart_id)
on delete restrict,

constraint fk_orders_profile
foreign key(profile_id) references profiles(profile_id)
on delete restrict
);


create table order_items(
order_items_id bigint generated always as identity primary key,
order_id bigint not null,
variant_id bigint not null,
quantity int not null
check(quantity > 0),
price_at_order_time numeric(10,2) check(price_at_order_time >= 0.0) not null,

constraint fk_order_items
foreign key(order_id) references orders(order_id)
on delete cascade,

constraint fk_order_variant
foreign key(variant_id) references product_variants(variant_id)
on delete restrict
)

CREATE TABLE cart_items (
    cart_item_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    cart_id INT NOT NULL,
    variant_id INT NOT NULL,
    quantity INT CHECK (quantity > 0) not null,
    added_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT fk_carts_to_cart_items
        FOREIGN KEY (cart_id)
        REFERENCES carts(cart_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_variant_to_cart_items
        FOREIGN KEY (variant_id)
        REFERENCES product_variants(variant_id),

    CONSTRAINT uq_cart_variant UNIQUE (cart_id, variant_id)
);


// add triggers that enforce these logics
// - not more that 6 imagers per variant
// - only one product variant can represent a product
// - at most one active cart per profile if more than one cart exists convert to abandoned
// - at most 10 abandoned carts 


Indexes used : 
-- products
CREATE EXTENSION IF NOT EXISTS pg_trgm;

CREATE INDEX idx_products_name_trgm
ON products
USING GIN (product_name gin_trgm_ops);

-- product_variants
CREATE INDEX idx_variants_price_product
ON product_variants (price, product_id);

CREATE INDEX idx_variants_created_product
ON product_variants (created_at, product_id);

CREATE INDEX idx_variants_product_price
ON product_variants (product_id, price);

-- images
CREATE INDEX idx_images_variant
ON images (variant_id);

CREATE UNIQUE INDEX uniq_active_cart
ON carts(profile_id)
WHERE status = 'active';




